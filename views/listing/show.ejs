<% layout("layouts/boilerPlate") -%>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Show Listing</title>

    <!-- âœ… Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      /* ðŸŽ¨ Optional: Colorful rating bar */
      input[type="range"] {
        height: 8px;
        border-radius: 5px;
        background: linear-gradient(to right, #ff4d4d, #ffcc00, #00cc66);
        outline: none;
        appearance: none;
        width: 100%;
      }
      input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 18px;
        height: 18px;
        background-color: #007bff;
        border-radius: 50%;
        cursor: pointer;
      }
    </style>
  </head>

  <body class="bg-light">
    <div class="container mt-5">
      <div class="card listing-card shadow-sm" style="max-width: 800px; margin: auto">
        <h2 class="card-title mb-3 text-center mt-3"><%= listing.title %></h2>

        <% if (listing.image && listing.image.url) { %>
        <img
          src="<%= listing.image.url %>"
          class="card-img-top"
          alt="Listing Image"
          style="object-fit: cover; height: 300px"
        />
        <% } else { %>
        <div class="text-center p-5 bg-secondary text-white">
          <em>No image available</em>
        </div>
        <% } %>

        <div class="card-body">
          <i><%= listing.owner.username %></i>
          <br>
          <p class="card-text"><%= listing.description %></p>

          <ul class="list-group list-group-flush mb-3">
            <li class="list-group-item">
              <strong>Price:</strong> â‚¹ <%=
              listing.price.toLocaleString('en-IN') %>
            </li>
            <li class="list-group-item">
              <strong>Location:</strong> <%= listing.location %>
            </li>
            <li class="list-group-item">
              <strong>Country:</strong> <%= listing.country %>
            </li>
          </ul>
       <% if(currUser && listing.owner._id.equals(currUser._id)){ %>
    <div class="d-flex justify-content-between mt-4">
      <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary px-4">
        Edit Listing
      </a>

      <form
        action="/listings/<%= listing._id %>?_method=DELETE"
        method="POST"
        onsubmit="return confirm('Are you sure you want to delete this listing?');"
      >
        <button type="submit" class="btn btn-danger px-4">Delete</button>
      </form>
    </div>
<% } %>

          

          <div class="text-center mt-4">
            <a href="/listings" class="btn btn-secondary">Back to Listings</a>
          </div>
        </div>
      </div>

      <!-- âœ… Review Section -->
      <!-- Review Form -->
<% if(currUser){ %>
<div class="card listing-card shadow-sm mt-5 mb-5" style="max-width: 800px; margin: auto">
  <div class="card-body">
    <h4 class="card-title mb-4 text-center text-primary">ðŸ’¬ Leave a Review</h4>

    <form action="/listings/<%= listing.id %>/reviews" method="POST" novalidate class="needs-validation">

      <!-- Rating -->
      <div class="mb-3">
  <label class="form-label fw-bold">Rating</label>

  <div class="star-rating mb-2">
    <% for (let i = 1; i <= 5; i++) { %>
      <i class="fa-solid fa-star star" data-value="<%= i %>"></i>
    <% } %>
  </div>

  <input type="hidden" name="review[rating]" id="rating-value" required>
  <div class="invalid-feedback">Please select a rating.</div>
</div>


      <!-- Comment -->
      <div class="mb-3">
        <label class="form-label fw-bold">Comment</label>
        <textarea class="form-control" name="review[comment]" rows="4" required></textarea>
      </div>

      <div class="text-center">
        <button class="btn btn-success px-5">Submit Review</button>
      </div>
    </form>

    <hr />
  </div>
</div>
<% } %>

<!-- All Reviews -->
<div class="row justify-content-center">
  <div class="card listing-card my-4 shadow-sm col-12 col-sm-10 col-md-8 col-lg-6">
    <div class="card-body">

      <h4 class="card-title mb-3 text-center">
        All Reviews (<%= listing.reviews.length %>)
      </h4>

      <% if (listing.reviews.length > 0) { %>
        <% listing.reviews.forEach(review => { %>

          <% if (review.comment && review.comment.trim() !== "") { %>
            <div class="border-bottom pb-3 mb-3">

              <h6 class="mb-1">
                Rating:
                <span class="badge 
                  <%= review.rating >= 4 ? 'bg-success' : 
                      review.rating >= 2 ? 'bg-warning text-dark' : 'bg-danger' %>">
                  <%= review.rating %> â˜…
                </span>
              </h6>

              <p class="mb-0 text-muted">@<%= review.author.username %></p>

              <p class="mb-1"><%= review.comment %></p>

              <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" 
                    method="POST" class="mt-2">
                <button class="btn btn-sm btn-outline-danger">Delete</button>
              </form>

            </div>
          <% } %>

        <% }) %>
      <% } else { %>
        <p class="text-muted text-center">No reviews yet.</p>
      <% } %>

    </div>
  </div>
</div>


    </div>


    <!-- âœ… Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- âœ… Bootstrap Validation Script -->
    <script>
      (() => {
        "use strict";

        // Fetch all forms we want to apply custom validation
        const forms = document.querySelectorAll(".needs-validation");

        Array.from(forms).forEach((form) => {
          form.addEventListener(
            "submit",
            (event) => {
              if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
              }

              form.classList.add("was-validated");
            },
            false
          );
        });
      })();

      // rating through star
       const stars = document.querySelectorAll(".star-rating .star");
  const ratingInput = document.getElementById("rating-value");

  stars.forEach(star => {
    // Hover effect
    star.addEventListener("mouseover", () => {
      resetStars();
      highlightStars(star.dataset.value);
    });

    // Select star
    star.addEventListener("click", () => {
      ratingInput.value = star.dataset.value;
      resetStars();
      highlightStars(star.dataset.value, true);
    });

    // Remove hover effect when mouse leaves star area
    star.parentElement.addEventListener("mouseleave", () => {
      resetStars();
      if (ratingInput.value) highlightStars(ratingInput.value, true);
    });
  });

  function highlightStars(count, permanent = false) {
    stars.forEach(star => {
      if (star.dataset.value <= count) {
        star.classList.add(permanent ? "selected" : "hover");
      }
    });
  }

  function resetStars() {
    stars.forEach(star => star.classList.remove("selected", "hover"));
  }
    </script>
  </body>
</html>
